<!DOCTYPE html>
<html>
	<link href ="/css/general.css" rel="stylesheet">
	<link href ="/css/play.css" rel ="stylesheet">
	<script defer src = "/js/fontawesome-all.js"></script>
	<div class ="container">
	<head>
		<a href ="./index"><i class ="fa fa-home fa-2x"></i></a>
		<title>FocusFriend</title>
		<center>
			<h1>Focus Together!</h1>
			<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
				

				{{#with animals.[0]}}
						<img id ="image" src ="{{imageURL}}"/>
				{{/with}} 


	

	</head>
	<body>


		

			<!-- timer implemented below -->			
			<p id="demo"></p>

			<!-- PROGRESS BAR PRODUCTIVITY-->
			<br>
			<h4>Productivity</h4>
			<div id ="productivityProgress">
				<div id ="productivityBar">100%</div>
			</div>
			<br>
			<br>
			<br>

			<!-- PROGRESS BAR TIME-->
			<h4>Progress</h4>
			<div id ="userProgress">
				<div id ="progressBar">0%</div>
			</div>
			<br>
			<br>
			<br>
			<br>
			<button id="clickButton" onclick ="move(); calculate()">Begin Session</button>

			<script type="text/javascript">
				$(document).ready(function(){
				    $("#clickButton").trigger('click'); 
				    $("#clickButton").hide();
				});
			</script>

 		
			<script>

			var totalTime = processInput();
			var productivityWidth = 100;
			var timeNotFocus = 0;

			function processInput() {
				//get user's minute and hour input
				var str = location.search;
				var hours = str.substring(str.indexOf("=") + 1, str.indexOf("&"));
				var minutes = str.substring(str.lastIndexOf("=") + 1);

				//convert the given input into milliseconds
				var totalTime = (hours * 3600000) + (minutes * 60000);
				//return the total time in milliseconds
				return totalTime;
			}

			function move() {
				//get the total time from this function into variable time
				var time = totalTime;
				//make that progress bar move
				var elem = document.getElementById("progressBar");
				var width = 1;

				//divide the total time into percentage, which is out of 100
				var count = time/100;
				
				//visual movement
				var id = setInterval(frame, count);
				function frame() {
					if (width >= 100) {
						clearInterval(id);
						completeTask();
					} else {
						width++;
						elem.style.width = width + '%';
						elem.innerHTML = width * 1 + '%';
					}
				}
			}

			//calculate total productivity time. Should be 100% initially, then decrease if the user is not being producitive
			function calculate() {
				var time = totalTime;
				var elem = document.getElementById("productivityBar");
				console.log("Productivity start ", productivityWidth);
				if(document.hasFocus() == false){
					setInterval (function() {
						timeNotFocus += 1000;
					}, 1000);
					var count = time/100;
					var id = setInterval(frame, count);
					function frame() {
						if (productivityWidth <= 0) {
							clearInterval(id);
						} else if (document.hasFocus()) {
							clearInterval(id);
						} else {
							console.log("Productivity when no Focus", productivityWidth);
							--productivityWidth;
							console.log("timeNotFocus = " + timeNotFocus);
							elem.style.width = productivityWidth + '%';
							elem.innerHTML = productivityWidth * 1 + '%';
							console.log("Productivity after decrement", productivityWidth);
							
						}
					}
				}
			}
					
						
						var animalUrl = localStorage.getItem("animalUrl");
						console.log(animalUrl);
						//logic to set picPaths
			  			 if (animalUrl == "http://localhost:3000/images/DogHouse.png") {
			  			 	var picPaths = ['./images/Happy1.png','./images/Happy2.png','./images/DogHappy3.png','/images/DogHappy4.png','/images/DogHappy5.png']
			  			 	var sadPicPaths = ['./images/Sad.png','./images/DogSad2.png','./images/DogSad3.png']
			  			 
			  			 }
			  			  if (animalUrl == "http://localhost:3000/images/BearHouse.png") {
			  			  	var picPaths = ['./images/BearHappy1.png','./images/BearHappy2.png','./images/BearHappy3.png','./images/BearHappy4.png','./images/BearHappy5.png']
			  			  	var sadPicPaths = ['./images/BearSad1.png','./images/BearSad2.png','./images/BearSad3.png']
			  			 
			  			 }
			  			  if (animalUrl == "http://localhost:3000/images/PigHouse.png") {
			  			  		var picPaths = ['./images/PigHappy1.png','./images/PigHappy2.png','./images/PigHappy3.png','./images/PigHappy4.png','./images/PigHappy5.png']
			  			  		var sadPicPaths = ['./images/PigSad1.png','./images/PigSad2.png','./images/PigSad3.png']
			  			 	 	
			  			 }
			  			 if (animalUrl == "http://localhost:3000/images/TigerHouse.png")  {
			  			  	var picPaths = ['./images/TigerHappy1.png','./images/TigerHappy2.png','./images/TigerHappy3.png','./images/TigerHappy4.png','./images/TigerHappy5.png']
			  			  	var sadPicPaths = ['./images/TigerSad1.png','./images/TigerSad2.png','./images/TigerSad3.png']

			  			 }
						setInterval("myFunction()", 10);
						


						
					var done = false;
					function myFunction() {
				    	if(document.hasFocus()) {

				    	var time = processInput();
						//about enough to get through all images, will change magic number to size of picpath later
						var stagger = (time/5) + 2000;
		
			            var curPic = -1;
			            //preload the images for smooth animation
			            var imgO = new Array();
			            for(i=0; i < picPaths.length; i++) {
			                imgO[i] = new Image();
			                imgO[i].src = picPaths[i];
			            }

			            function swapImage() {
			                curPic = (++curPic > picPaths.length-1)? 0 : curPic;
			                imgCont.src = imgO[curPic].src;
			                setTimeout(swapImage,stagger);
			            }

			            window.onload=function() {
			                imgCont = document.getElementById('image');
			                swapImage();
			            	}

			           // done = false;

			        	}


				   		else {
				   			imgCont = document.getElementById('image');
				   			for (i=0; i < sadPicPaths.length; i++) {
				   			imgCont.src = sadPicPaths[i]; 
				   			}
				   			
				   			offPage(done);
				   			
							//setInterval(function() {imgCont.src = "./images/Sad.png"}, 10);

						
						}
					}


			// function progressMove(){
			// 	var prg = document.getElementById("progress");
			// 	var percent = document.getElementById("percentage");
			// 	var count = 5;
			// 	var progress = 0;
			// 	var id = setInterval(frame, 50);

			// 	function frame() {
			// 		if (progress == 20 && count == 100) {
			// 			clearInterval(id);
			// 		} else {
			// 			progress += 1;
			// 			count += 10;
			// 			prg.style.width = progress + 'em';
			// 			percent.innerHTML = count + '%';
			// 		}
			// 	}

			// }

			// progressMove();

			</script>

			<br>
			<br>

			<!-- timer implemented below -->
			<script>
				function completeTask (){
				setTimeout(function(){ alert("Good job! Go Home and rest"); }, 2000);
				var percentage = (timeNotFocus/totalTime) * 100;

					// var fs = require("fs");
					// 	var obj {
					// 		"beginmark": ",{",
					// 		"date": "Tuesday",
					// 		"category": "[0, 1]",
					// 		"series": percentage,
					// 		"endmark": "}"
					// 	};

					// fs.writeFile("./workdata.json", JSON.stringify(obj), (err) ==> {
					// 	if(err){
					// 		console.error(err);
					// 		return;
					// 	}
					// 	console.log("success");
					// });
				}

				function offPage () {
					if (done == false) {
						setTimeout(function(){ alert("Your friend became sad when you lost focus"); }, 2000);
						done = true;
						}
					}
			</script>
			
	</body>
	</center>
	</div>
</html>
